<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CupCafe Menu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .menu-img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container py-4">
    <h2 class="text-center mb-4">â˜• CupCafe Menu</h2>

    <!-- Main Menu -->
    <div class="row justify-content-center" id="mainMenu"></div>

    <!-- SubMenu Buttons -->
    <div id="subMenuSection" class="my-4" style="display:none;">
      <h5>Select a Drink</h5>
      <div id="subMenuButtons" class="d-flex flex-wrap gap-2"></div>
    </div>

    <!-- Options -->
    <div id="optionsSection" class="my-4" style="display:none;">
      <h5>Customize Your Drink</h5>
      <div class="row">
        <div class="col-md-4 mb-2">
          <label for="beanSelect" class="form-label">Bean Type</label>
          <select class="form-select" id="beanSelect"></select>
        </div>
        <div class="col-md-4 mb-2">
          <label for="milkSelect" class="form-label">Milk Type</label>
          <select class="form-select" id="milkSelect"></select>
        </div>
        <div class="col-md-4 mb-2">
          <label for="sizeSelect" class="form-label">Size</label>
          <select class="form-select" id="sizeSelect"></select>
        </div>
      </div>
      <button class="btn btn-success mt-3" onclick="addToOrder()">Add to Order</button>
    </div>

    <!-- Order List -->
    <div class="my-4">
      <h5>Order Summary</h5>
      <ul id="orderList" class="list-group mb-3"></ul>
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>

  <!-- QRious for QR generation -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <script>
    let menuData = [], beans = [], milks = [], sizes = [];
    let selectedMainMenu = null;
    let selectedSubMenu = null;
    let orderItems = [];

    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error("Failed to load " + path);
      return await res.json();
    }

    async function init() {
      try {
        const menuJSON = await loadJSON("jsonData/Data_MenuItem_menu.json");
        const beansJSON = await loadJSON("jsonData/Data_MenuOption_bean.json");
        const milkJSON = await loadJSON("jsonData/Data_MenuOption_milk.json");
        const sizeJSON = await loadJSON("jsonData/Data_MenuOption_size.json");

        menuData = menuJSON.menuItems || menuJSON;
        beans = beansJSON.options || beansJSON;
        milks = milkJSON.options || milkJSON;
        sizes = sizeJSON.options || sizeJSON;

        renderMainMenu();
      } catch (err) {
        console.error("Initialization error:", err);
      }
    }

    function renderMainMenu() {
      const container = document.getElementById("mainMenu");
      container.innerHTML = "";
      menuData.forEach(item => {
        const col = document.createElement("div");
        col.className = "col-4 col-md-2 text-center mb-3";
        col.innerHTML = `
          <img src="img/${item.id}.png" alt="${item.name}" class="menu-img rounded-circle border" onclick="selectMainMenu(${item.id})" />
          <div class="fw-bold mt-1">${item.name}</div>
        `;
        container.appendChild(col);
      });
    }

    function selectMainMenu(menuId) {
      selectedMainMenu = menuData.find(m => m.id === menuId);
      selectedSubMenu = null;
      document.getElementById("optionsSection").style.display = "none";

      const subMenuContainer = document.getElementById("subMenuButtons");
      subMenuContainer.innerHTML = "";

      selectedMainMenu.subMenu.forEach(sm => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-primary";
        btn.textContent = sm.name;
        btn.onclick = () => selectSubMenu(sm.id);
        subMenuContainer.appendChild(btn);
      });

      document.getElementById("subMenuSection").style.display = "block";
    }

    function selectSubMenu(subMenuId) {
      selectedSubMenu = subMenuId;

      populateSelect("beanSelect", beans);
      populateSelect("milkSelect", milks);
      populateSelect("sizeSelect", sizes);

      document.getElementById("optionsSection").style.display = "block";
    }

    function populateSelect(selectId, list) {
      const select = document.getElementById(selectId);
      select.innerHTML = "";
      list.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.id;
        option.textContent = opt.name;
        select.appendChild(option);
      });
    }

    function addToOrder() {
      const beanId = document.getElementById("beanSelect").value;
      const milkId = document.getElementById("milkSelect").value;
      const sizeId = document.getElementById("sizeSelect").value;

      if (!selectedSubMenu || !beanId || !milkId || !sizeId) {
        alert("Please select all options.");
        return;
      }

      const itemNumber = `${selectedSubMenu}${beanId}${milkId}${sizeId}`;
      orderItems.push(itemNumber);
      updateOrderList();
      generateQRCode(orderItems);
    }

    function updateOrderList() {
      const list = document.getElementById("orderList");
      list.innerHTML = "";
      orderItems.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = item;
        list.appendChild(li);
      });
    }

    function generateQRCode(dataArray) {
      new QRious({
        element: document.getElementById("qrCanvas"),
        size: 200,
        value: dataArray.join("\n")
      });
    }

    window.onload = init;
  </script>
</body>
</html>
